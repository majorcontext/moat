name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Collapse previous Claude reviews
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: ./.github/scripts/collapse-previous-reviews.sh

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: |
            Use the /code-review skill to review this pull request.

            Use the repository's CLAUDE.md for guidance on style, conventions, and architecture.

            Review as a second pair of eyes — catch things the author or a coding agent
            would miss. Think about:
            - Bugs, logic errors, off-by-one mistakes, nil/zero-value pitfalls
            - Security issues (injection, credential leaks, path traversal, TOCTOU)
            - Race conditions, deadlocks, missing synchronization
            - Error handling gaps — unchecked errors, swallowed failures, misleading messages
            - Edge cases and failure modes that aren't covered
            - Missing or outdated documentation when code changes user-facing behavior
            - For docs changes, check against docs/STYLE-GUIDE.md for tone, voice, and formatting
            - Duplicated code that should be shared or consolidated
            - Misuse of internal conventions (e.g. log vs ui, error message quality)

            Don't flag pure style preferences or formatting. Do flag naming or structure
            issues that hurt readability or could cause confusion.

            Be concise and specific — quote the relevant code, explain why it's a problem,
            and suggest a fix when the solution isn't obvious. If the PR looks good, say so
            briefly.

            Use inline comments for specific code issues. Use a top-level PR comment for
            the overall summary.
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
